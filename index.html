<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»å‹™æŒ‘æˆ°ç³»çµ± </title>
    <style>
        :root { --main-blue: #007bff; --success-green: #28a745; --fail-red: #dc3545; --warn-orange: #fd7e14; }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f8f9fa; padding: 20px; max-width: 600px; margin: auto; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        .status-container { display: flex; justify-content: space-around; text-align: center; }
        .status-box { flex: 1; }
        .status-num { font-size: 24px; font-weight: bold; display: block; }
        
        .item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f1f1; }
        .item:last-child { border-bottom: none; }
        .task-text { flex-grow: 1; font-size: 16px; }
        
        button { border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-draw { background: var(--main-blue); color: white; width: 100%; padding: 15px; font-size: 18px; }
        .btn-shop { background: var(--warn-orange); color: white; width: 100%; padding: 10px; font-size: 16px; margin-top: 10px; }
        .btn-ok { background: var(--success-green); color: white; margin-right: 5px; }
        .btn-no { background: var(--fail-red); color: white; }
        .btn-del { background: #666; color: white; padding: 4px 8px; font-size: 12px; }
        button:disabled { background: #ccc !important; cursor: not-allowed; }

        /* æ‡²ç½°åˆ—è¡¨å€åŸŸ (ç¾åœ¨æ”¹ç‚ºåˆ—è¡¨é¡¯ç¤º) */
        #punishSection { background: #fff3f3; border: 2px dashed var(--fail-red); padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .punish-header { color: var(--fail-red); font-weight: bold; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }

        .input-area { display: flex; gap: 5px; margin-top: 10px; flex-wrap: wrap;}
        .input-row { display: flex; gap: 5px; width: 100%; }
        input, select { flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .input-small { flex-grow: 0 !important; width: 80px; } 
    </style>
</head>
<body>

    <div class="card">
        <h1 style="text-align: center; margin: 0 0 20px 0;">ğŸ® æˆé•·ç³»çµ± </h1>
        <div class="status-container">
            <div class="status-box">
                <span class="status-num" style="color: var(--success-green);" id="scoreDisplay">0</span>
                ç´¯ç©ç©åˆ†
            </div>
            <div class="status-box">
                <span class="status-num" style="color: var(--fail-red);" id="failDisplay">0 / 3</span>
                å¤±æ•—ç´¯ç©
            </div>
        </div>
        
        <button class="btn-shop" onclick="reduceDifficulty()">ğŸ›¡ï¸ æ¶ˆè€— 300 ç©åˆ†ï¼šé™ä½æœ€é«˜æ‡²ç½°å€ç‡ 1%</button>
        
        <button class="btn-draw" style="margin-top:10px;" onclick="drawTasks()">ğŸ² æŠ½å–ä»Šæ—¥ä»»å‹™</button>
        <div style="text-align: center; font-size: 12px; color: #666; margin-top: 5px;">
            (è‹¥åŒæ™‚å­˜åœ¨ 2 å€‹ä»¥ä¸Šæœªå®Œæˆæ‡²ç½°ï¼ŒæŠ½å–æ™‚æ‰€æœ‰æ‡²ç½°å€ç‡ +1%)
        </div>
    </div>

    <div id="punishSection">
        <div class="punish-header">
            <span>ğŸš¨ æœªå®Œæˆçš„æ‡²ç½°</span>
            <span id="punishCount" style="font-size: 14px;">(0)</span>
        </div>
        <div id="activePunishList"></div>
    </div>

    <div class="card">
        <h2>ğŸ¯ ä»Šæ—¥ä»»å‹™</h2>
        <div id="todayList">é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹...</div>
    </div>

    <div class="card">
        <h2>ğŸ“š ä¸€èˆ¬ä»»å‹™åº«</h2>
        <div class="input-area">
            <input type="text" id="taskInput" placeholder="è¼¸å…¥ä»»å‹™æŒ‡ä»¤...">
            <button class="btn-ok" onclick="addToPool('normal')">æ–°å¢</button>
        </div>
        <div id="normalPool" style="margin-top: 10px; max-height: 150px; overflow-y: auto;"></div>
    </div>

    <div class="card">
        <h2>ğŸ’€ æ‡²ç½°ä»»å‹™åº« (ç´¯é€²å€ç‡)</h2>
        <div class="input-area">
            <div class="input-row">
                <select id="punishType" onchange="togglePunishInputs()" style="flex-grow:0; width: 100px;">
                    <option value="other">å…¶ä»–</option>
                    <option value="count">è¨ˆæ¬¡</option>
                    <option value="time">è¨ˆæ™‚</option>
                </select>
                <input type="text" id="punishName" placeholder="ä»»å‹™åç¨± (ä¾‹: æ·±è¹²)">
            </div>
            <div class="input-row" id="punishValueRow" style="display:none;">
                <input type="number" id="punishBase" class="input-small" placeholder="æ•¸å€¼">
                <input type="text" id="punishUnit" class="input-small" placeholder="å–®ä½">
                <button class="btn-no" onclick="addToPool('punish')">æ–°å¢</button>
            </div>
            <div class="input-row" id="punishBtnRow">
                <button class="btn-no" style="width: 100%;" onclick="addToPool('punish')">æ–°å¢</button>
            </div>
        </div>
        <div id="punishPool" style="margin-top: 10px; max-height: 200px; overflow-y: auto;"></div>
    </div>

    <script>
        // --- 1. è³‡æ–™çµæ§‹æ›´æ–° ---
        
        const defaultTasks = ["å–æ°´ 500cc", "æ·±è¹² 10 ä¸‹", "çœ‹æ›¸ 10 åˆ†é˜"];
        // æ›´æ–°ï¼šæ”¹ç”¨ addedPercent ä»£è¡¨ç´¯åŠ çš„ç™¾åˆ†æ¯” (ä¾‹å¦‚ 5 ä»£è¡¨ +5%)
        const defaultPunishments = [
            { type: 'count', name: 'åŸåœ°è·³', base: 50, unit: 'ä¸‹', addedPercent: 0 },
            { type: 'time', name: 'å¹³æ¿æ”¯æ’', base: 30, unit: 'ç§’', addedPercent: 0 },
            { type: 'other', name: 'å¤§å–Šæˆ‘æ˜¯ç¬¨è›‹', base: 0, unit: '', addedPercent: 0 }
        ];

        let data = {
            score: parseInt(localStorage.getItem('task_score')) || 0,
            failCount: parseInt(localStorage.getItem('task_fail')) || 0,
            normalPool: JSON.parse(localStorage.getItem('task_pool_normal')) || defaultTasks,
            punishPool: JSON.parse(localStorage.getItem('task_pool_punish')) || defaultPunishments,
            todayTasks: JSON.parse(localStorage.getItem('task_today')) || [],
            // æ›´æ–°ï¼šactivePunish æ”¹ç‚ºé™£åˆ—ï¼Œå› ç‚ºå¯ä»¥å †ç–Šå¤šå€‹æ‡²ç½°
            activePunishments: JSON.parse(localStorage.getItem('task_active_punishments')) || [] 
        };

        // --- è³‡æ–™é·ç§» (ç›¸å®¹èˆŠç‰ˆ) ---
        // å°‡èˆŠçš„ level æ¬„ä½è½‰æ›ç‚º addedPercent (1 level = 5%)
        data.punishPool.forEach(p => {
            if (p.level !== undefined) {
                p.addedPercent = p.level * 5;
                delete p.level;
            }
            if (p.addedPercent === undefined) p.addedPercent = 0;
        });

        // --- 2. æ ¸å¿ƒé‚è¼¯ ---

        function drawTasks() {
            if (data.normalPool.length < 3) return alert("ä»»å‹™åº«è‡³å°‘éœ€è¦ 3 å€‹ä»»å‹™ï¼");
            
            // é‚è¼¯è®Šæ›´ï¼šå¦‚æœåŒæ™‚å­˜åœ¨ 2 å€‹æˆ–ä»¥ä¸Šæœªå®Œæˆæ‡²ç½°ï¼Œæ‰€æœ‰ã€Œç›®å‰åœ¨åˆ—è¡¨ä¸­çš„ã€æ‡²ç½°å€ç‡ +1%
            if (data.activePunishments.length >= 2) {
                let msg = "âš ï¸ ç´¯ç©å¤ªå¤šæ‡²ç½°ï¼";
                
                // æ‰¾å‡ºç›®å‰æ´»èºæ‡²ç½°å°æ‡‰çš„åº«å­˜é …ç›®ï¼Œä¸¦å¢åŠ é›£åº¦
                data.activePunishments.forEach(activeP => {
                    // é€éåç¨±æ¯”å°å›åˆ°åŸå§‹åº«å­˜ (ç°¡å–®èµ·è¦‹å‡è¨­åç¨±ä¸é‡è¤‡ï¼Œåš´è¬¹æ‡‰åŠ ID)
                    const poolItem = data.punishPool.find(p => p.name === activeP.name);
                    if (poolItem) {
                        poolItem.addedPercent += 1;
                        msg += `\n[${poolItem.name}] é›£åº¦æå‡è‡³ ${100 + poolItem.addedPercent}%`;
                    }
                });
                alert(msg);
                // åŒæ­¥æ›´æ–°ç•¶å‰æ´»èºåˆ—è¡¨é¡¯ç¤ºçš„æ•¸å€¼ (é¸ç”¨ï¼Œæˆ–ç­‰åˆ°é‡æ–°æ¸²æŸ“)
            }

            // æŠ½å–æ¯æ—¥ä»»å‹™ (ä¸å†è¢«æ‡²ç½°é˜»æ“‹)
            const shuffled = [...data.normalPool].sort(() => 0.5 - Math.random());
            data.todayTasks = shuffled.slice(0, 3).map(cmd => ({ cmd, status: 'pending' }));
            
            saveAndRender();
        }

        function updateTaskStatus(index, status) {
            if (data.todayTasks[index].status !== 'pending') return;
            data.todayTasks[index].status = status;

            if (status === 'done') {
                data.score += 10;
            } else {
                data.failCount++;
                if (data.failCount >= 3) {
                    triggerPunish();
                    data.failCount = 0; // è§¸ç™¼å¾Œæ­¸é›¶é‡æ–°è¨ˆç®—
                }
            }
            saveAndRender();
        }

        // è§¸ç™¼æ‡²ç½° (åŠ å…¥åˆ°å †ç–Šåˆ—è¡¨)
        function triggerPunish() {
            if (data.punishPool.length === 0) return alert("ç„¡æ‡²ç½°åº«å­˜ï¼");

            const idx = Math.floor(Math.random() * data.punishPool.length);
            const task = data.punishPool[idx]; // é€™æ˜¯ Referenceï¼Œä¿®æ”¹å®ƒæœƒå½±éŸ¿åº«å­˜

            // 1. è¨ˆç®—ç•¶æ¬¡æ•¸å€¼
            let finalValue = 0;
            let displayStr = "";
            let multiplier = 1 + (task.addedPercent / 100);

            if (task.type === 'other') {
                displayStr = task.name;
            } else {
                finalValue = task.base * multiplier;
                // å››æ¨äº”å…¥
                finalValue = Math.round(finalValue);
                displayStr = `${task.name} ${finalValue} ${task.unit}`;
            }

            // 2. åŠ å…¥æ´»èºæ‡²ç½°åˆ—è¡¨ (å„²å­˜ç•¶ä¸‹å¿«ç…§)
            data.activePunishments.push({
                name: task.name,
                display: displayStr,
                timestamp: new Date().getTime() // å”¯ä¸€è­˜åˆ¥ç”¨
            });

            // 3. åº«å­˜é›£åº¦æ°¸ä¹… +5% (ç´¯åŠ )
            task.addedPercent += 5;

            alert(`âŒ å¤±æ•—ä¸‰æ¬¡ï¼è¿½åŠ æ‡²ç½°ï¼š${displayStr}\n(æ­¤ä»»å‹™ä¸‹æ¬¡åŸºç¤å€ç‡è®Šç‚º ${100 + task.addedPercent}%)`);
            saveAndRender();
        }

        // å®ŒæˆæŸå€‹æ‡²ç½°
        function completePunish(index) {
            data.activePunishments.splice(index, 1);
            saveAndRender();
        }

        // æ–°å¢åŠŸèƒ½ï¼šæ¶ˆè€—ç©åˆ†é™ä½é›£åº¦
        function reduceDifficulty() {
            if (data.score < 300) return alert("ç©åˆ†ä¸è¶³ï¼éœ€è¦ 300 ç©åˆ†ã€‚");
            
            // æ‰¾å‡ºå€ç‡æœ€é«˜çš„ä¸€ç¾¤ (addedPercent æœ€é«˜)
            // å…ˆéæ¿¾å‡ºé 'other' é¡å‹ï¼Œå› ç‚º 'other' é€šå¸¸æ²’æœ‰æ•¸å€¼å€ç‡æ¦‚å¿µï¼Œæˆ–è€…å€ç‡å°å…¶ç„¡æ„ç¾©
            // è‹¥ 'other' ä¹Ÿæœ‰é›£åº¦æ¦‚å¿µå¯ç§»é™¤ filter
            const validPool = data.punishPool.filter(p => p.type !== 'other');
            
            if (validPool.length === 0) return alert("æ²’æœ‰å¯é™ä½é›£åº¦çš„æ•¸å€¼å‹æ‡²ç½°ï¼");

            // æ‰¾æœ€å¤§å€¼
            const maxPercent = Math.max(...validPool.map(p => p.addedPercent));
            // æ‰¾å‡ºæ‰€æœ‰ç­‰æ–¼æœ€å¤§å€¼çš„ä»»å‹™
            const candidates = validPool.filter(p => p.addedPercent === maxPercent);
            
            // éš¨æ©Ÿé¸ä¸€å€‹
            const target = candidates[Math.floor(Math.random() * candidates.length)];

            // ä¸‹é™æª¢æŸ¥ï¼šç¸½å€ç‡ä¸èƒ½ä½æ–¼ 10% (å³ addedPercent ä¸èƒ½ä½æ–¼ -90)
            // é€™è£¡å‡è¨­åˆå§‹ 100% (addedPercent=0)ï¼Œä¸‹é™ 10% æ„å‘³è‘— addedPercent -90
            if (100 + target.addedPercent <= 10) {
                return alert("è©²ä»»å‹™å€ç‡å·²é”ä¸‹é™ (10%)ï¼Œç„¡æ³•å†é™ä½ï¼");
            }

            // åŸ·è¡Œæ‰£æ¬¾èˆ‡é™ä½
            data.score -= 300;
            target.addedPercent -= 1; // é™ä½ 1%

            alert(`ğŸ›¡ï¸ æˆåŠŸï¼ä»»å‹™ [${target.name}] çš„å€ç‡é™ä½äº† 1%ã€‚\nç•¶å‰å€ç‡ï¼š${100 + target.addedPercent}%`);
            saveAndRender();
        }

        // æ–°å¢ä»»å‹™åˆ°åº«
        function addToPool(poolType) {
            if (poolType === 'normal') {
                const input = document.getElementById('taskInput');
                if (!input.value.trim()) return;
                data.normalPool.push(input.value.trim());
                input.value = "";
            } else {
                const pType = document.getElementById('punishType').value;
                const pName = document.getElementById('punishName').value.trim();
                const pBase = parseFloat(document.getElementById('punishBase').value);
                let pUnit = document.getElementById('punishUnit').value.trim();

                if (!pName) return alert("è«‹è¼¸å…¥ä»»å‹™åç¨±");
                if (pType !== 'other') {
                    if (isNaN(pBase) || pBase <= 0) return alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„åŸºç¤æ•¸å€¼");
                    if (pType === 'time') pUnit = "ç§’";
                    if (!pUnit) return alert("è«‹è¼¸å…¥å–®ä½");
                }

                data.punishPool.push({
                    type: pType,
                    name: pName,
                    base: pType === 'other' ? 0 : pBase,
                    unit: pUnit,
                    addedPercent: 0 // åˆå§‹ +0%
                });

                document.getElementById('punishName').value = "";
                document.getElementById('punishBase').value = "";
                if(pType !== 'time') document.getElementById('punishUnit').value = "";
            }
            saveAndRender();
        }

        function deleteFromPool(type, index) {
            if (type === 'normal') data.normalPool.splice(index, 1);
            else data.punishPool.splice(index, 1);
            saveAndRender();
        }

        // --- 3. ä»‹é¢äº’å‹•è¼”åŠ© ---

        function togglePunishInputs() {
            const type = document.getElementById('punishType').value;
            const valRow = document.getElementById('punishValueRow');
            const btnRow = document.getElementById('punishBtnRow');
            const unitInput = document.getElementById('punishUnit');

            if (type === 'other') {
                valRow.style.display = 'none';
                btnRow.style.display = 'flex';
            } else {
                valRow.style.display = 'flex';
                btnRow.style.display = 'none';
                
                if (type === 'time') {
                    unitInput.value = "ç§’";
                    unitInput.disabled = true;
                    unitInput.style.backgroundColor = "#eee";
                } else {
                    unitInput.value = "";
                    unitInput.disabled = false;
                    unitInput.style.backgroundColor = "white";
                    unitInput.placeholder = "å–®ä½";
                }
            }
        }

        // --- 4. æ¸²æŸ“èˆ‡å„²å­˜ ---

        function saveAndRender() {
            localStorage.setItem('task_score', data.score);
            localStorage.setItem('task_fail', data.failCount);
            localStorage.setItem('task_pool_normal', JSON.stringify(data.normalPool));
            localStorage.setItem('task_pool_punish', JSON.stringify(data.punishPool));
            localStorage.setItem('task_today', JSON.stringify(data.todayTasks));
            localStorage.setItem('task_active_punishments', JSON.stringify(data.activePunishments));

            document.getElementById('scoreDisplay').innerText = data.score;
            document.getElementById('failDisplay').innerText = data.failCount + " / 3";

            // æ¸²æŸ“æœªå®Œæˆæ‡²ç½°åˆ—è¡¨
            const punishSection = document.getElementById('punishSection');
            const punishListDiv = document.getElementById('activePunishList');
            document.getElementById('punishCount').innerText = `(${data.activePunishments.length})`;

            if (data.activePunishments.length > 0) {
                punishSection.style.display = 'block';
                punishListDiv.innerHTML = data.activePunishments.map((p, i) => `
                    <div class="item" style="border-color: #ffcccc;">
                        <span style="font-weight:bold; color: #a00;">${p.display}</span>
                        <button class="btn-ok" onclick="completePunish(${i})">å®Œæˆ</button>
                    </div>
                `).join('');
            } else {
                punishSection.style.display = 'none';
            }

            // æ¸²æŸ“ä»Šæ—¥ä»»å‹™
            const todayDiv = document.getElementById('todayList');
            if (data.todayTasks.length === 0) {
                todayDiv.innerHTML = "å°šæœªæŠ½å–ä»»å‹™";
            } else {
                todayDiv.innerHTML = data.todayTasks.map((t, i) => `
                    <div class="item">
                        <span class="task-text" style="${t.status !== 'pending' ? 'text-decoration: line-through; color: #999;' : ''}">${t.cmd}</span>
                        ${t.status === 'pending' ? `
                            <button class="btn-ok" onclick="updateTaskStatus(${i}, 'done')">å®Œæˆ</button>
                            <button class="btn-no" onclick="updateTaskStatus(${i}, 'fail')">å¤±æ•—</button>
                        ` : `<span>${t.status === 'done' ? 'âœ…' : 'âŒ'}</span>`}
                    </div>
                `).join('');
            }

            renderPoolList('normalPool', 'normal');
            renderPunishList();
        }

        function renderPoolList(elementId, type) {
            const list = data.normalPool;
            document.getElementById(elementId).innerHTML = list.map((cmd, i) => `
                <div class="item">
                    <span style="font-size: 14px;">${cmd}</span>
                    <button class="btn-del" onclick="deleteFromPool('${type}', ${i})">åˆªé™¤</button>
                </div>
            `).join('');
        }

        // æ¸²æŸ“æ‡²ç½°åº« (é¡¯ç¤ºå€ç‡èˆ‡åŸºç¤å€¼)
        function renderPunishList() {
            const list = data.punishPool;
            document.getElementById('punishPool').innerHTML = list.map((item, i) => {
                let desc = "";
                if (item.type === 'other') {
                    desc = item.name;
                } else {
                    // è¨ˆç®—ç•¶å‰å€ç‡
                    const currentRate = 100 + item.addedPercent;
                    desc = `<b>${item.name}</b> <span style="color:#666; font-size:12px;">(å€ç‡:${currentRate}% | åŸºç¤:${item.base}${item.unit})</span>`;
                }

                return `
                <div class="item">
                    <span style="font-size: 14px;">${desc}</span>
                    <button class="btn-del" onclick="deleteFromPool('punish', ${i})">åˆªé™¤</button>
                </div>
            `}).join('');
        }

        togglePunishInputs();
        saveAndRender();

    </script>
</body>
</html>
