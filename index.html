<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»å‹™æŒ‘æˆ°ç³»çµ± (å‡ç´šç‰ˆ)</title>
    <style>
        :root { --main-blue: #007bff; --success-green: #28a745; --fail-red: #dc3545; --warn-orange: #fd7e14; }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f8f9fa; padding: 20px; max-width: 600px; margin: auto; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        .status-container { display: flex; justify-content: space-around; text-align: center; }
        .status-box { flex: 1; }
        .status-num { font-size: 24px; font-weight: bold; display: block; }
        
        .item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f1f1; }
        .item:last-child { border-bottom: none; }
        .task-text { flex-grow: 1; font-size: 16px; }
        
        button { border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-draw { background: var(--main-blue); color: white; width: 100%; padding: 15px; font-size: 18px; }
        .btn-ok { background: var(--success-green); color: white; margin-right: 5px; }
        .btn-no { background: var(--fail-red); color: white; }
        .btn-del { background: #666; color: white; padding: 4px 8px; font-size: 12px; }
        button:disabled { background: #ccc !important; cursor: not-allowed; }

        #punishBanner { background: #fff3f3; border: 2px dashed var(--fail-red); padding: 15px; border-radius: 8px; color: var(--fail-red); text-align: center; margin-bottom: 20px; display: none; }

        /* ä¿®æ”¹å¾Œçš„è¼¸å…¥å€æ¨£å¼ï¼Œæ”¯æ´å¤šæ¬„ä½ */
        .input-area { display: flex; gap: 5px; margin-top: 10px; flex-wrap: wrap;}
        .input-row { display: flex; gap: 5px; width: 100%; }
        input, select { flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        /* è®“æ•¸å€¼è¼¸å…¥æ¡†å°ä¸€é» */
        .input-small { flex-grow: 0 !important; width: 80px; } 
    </style>
</head>
<body>

    <div class="card">
        <h1 style="text-align: center; margin: 0 0 20px 0;">ğŸ® æˆ‘çš„æˆé•·ç³»çµ± (Pro)</h1>
        <div class="status-container">
            <div class="status-box">
                <span class="status-num" style="color: var(--success-green);" id="scoreDisplay">0</span>
                ç´¯ç©ç©åˆ†
            </div>
            <div class="status-box">
                <span class="status-num" style="color: var(--fail-red);" id="failDisplay">0 / 3</span>
                å¤±æ•—ç´¯ç©
            </div>
        </div>
        <button class="btn-draw" style="margin-top:20px;" onclick="drawTasks()">ğŸ² æŠ½å–ä»Šæ—¥ä»»å‹™</button>
    </div>

    <div id="punishBanner">
        <h3>ğŸš¨ æ‡²ç½°åŸ·è¡Œä¸­</h3>
        <p id="punishText" style="font-size: 18px; font-weight: bold;"></p>
        <div id="punishDetail" style="font-size: 14px; color: #666; margin-bottom: 10px;"></div>
        <button class="btn-ok" onclick="clearPunish()">æˆ‘å·²å®Œæˆæ‡²ç½° (é‡ç½®å¤±æ•—æ•¸)</button>
    </div>

    <div class="card">
        <h2>ğŸ¯ ä»Šæ—¥ä»»å‹™</h2>
        <div id="todayList">é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹...</div>
    </div>

    <div class="card">
        <h2>ğŸ“š ä¸€èˆ¬ä»»å‹™åº«</h2>
        <div class="input-area">
            <input type="text" id="taskInput" placeholder="è¼¸å…¥ä»»å‹™æŒ‡ä»¤...">
            <button class="btn-ok" onclick="addToPool('normal')">æ–°å¢</button>
        </div>
        <div id="normalPool" style="margin-top: 10px; max-height: 150px; overflow-y: auto;"></div>
    </div>

    <div class="card">
        <h2>ğŸ’€ æ‡²ç½°ä»»å‹™åº« (ç´¯é€²åˆ¶)</h2>
        <div class="input-area">
            <div class="input-row">
                <select id="punishType" onchange="togglePunishInputs()" style="flex-grow:0; width: 100px;">
                    <option value="other">å…¶ä»–</option>
                    <option value="count">è¨ˆæ¬¡</option>
                    <option value="time">è¨ˆæ™‚</option>
                </select>
                <input type="text" id="punishName" placeholder="ä»»å‹™åç¨± (ä¾‹: æ·±è¹²)">
            </div>
            <div class="input-row" id="punishValueRow" style="display:none;">
                <input type="number" id="punishBase" class="input-small" placeholder="æ•¸å€¼">
                <input type="text" id="punishUnit" class="input-small" placeholder="å–®ä½">
                <button class="btn-no" onclick="addToPool('punish')">æ–°å¢</button>
            </div>
            <div class="input-row" id="punishBtnRow">
                <button class="btn-no" style="width: 100%;" onclick="addToPool('punish')">æ–°å¢</button>
            </div>
        </div>
        <div id="punishPool" style="margin-top: 10px; max-height: 200px; overflow-y: auto;"></div>
    </div>

    <script>
        // --- 1. è³‡æ–™çµæ§‹æ›´æ–° ---
        
        const defaultTasks = ["å–æ°´ 500cc", "æ·±è¹² 10 ä¸‹", "çœ‹æ›¸ 10 åˆ†é˜"];
        // æ›´æ–°ï¼šé è¨­æ‡²ç½°æ”¹ç‚ºç‰©ä»¶æ ¼å¼ï¼ŒåŒ…å«é¡å‹èˆ‡åŸºç¤æ•¸å€¼
        const defaultPunishments = [
            { type: 'count', name: 'åŸåœ°è·³', base: 50, unit: 'ä¸‹', level: 0 },
            { type: 'time', name: 'å¹³æ¿æ”¯æ’', base: 30, unit: 'ç§’', level: 0 },
            { type: 'other', name: 'å¤§å–Šæˆ‘æ˜¯ç¬¨è›‹', base: 0, unit: '', level: 0 }
        ];

        let data = {
            score: parseInt(localStorage.getItem('task_score')) || 0,
            failCount: parseInt(localStorage.getItem('task_fail')) || 0,
            normalPool: JSON.parse(localStorage.getItem('task_pool_normal')) || defaultTasks,
            // è®€å–æ‡²ç½°åº«
            punishPool: JSON.parse(localStorage.getItem('task_pool_punish')) || defaultPunishments,
            todayTasks: JSON.parse(localStorage.getItem('task_today')) || [],
            activePunish: localStorage.getItem('task_active_punish') || ""
        };

        // --- è³‡æ–™é·ç§» (ç›¸å®¹æ€§è™•ç†) ---
        // å¦‚æœä½¿ç”¨è€…çš„èˆŠè³‡æ–™æ˜¯ç´”å­—ä¸²é™£åˆ—ï¼Œå°‡å…¶è½‰æ›ç‚ºæ–°çš„ç‰©ä»¶æ ¼å¼ï¼Œé¿å…ç¨‹å¼å´©æ½°
        if (data.punishPool.length > 0 && typeof data.punishPool[0] === 'string') {
            data.punishPool = data.punishPool.map(str => ({
                type: 'other', name: str, base: 0, unit: '', level: 0
            }));
            saveAndRender();
        }

        // --- 2. æ ¸å¿ƒé‚è¼¯ ---

        function drawTasks() {
            if (data.activePunish) return alert("è«‹å…ˆå®Œæˆæ‡²ç½°ä»»å‹™ï¼");
            if (data.normalPool.length < 3) return alert("ä»»å‹™åº«è‡³å°‘éœ€è¦ 3 å€‹ä»»å‹™ï¼");
            
            const shuffled = [...data.normalPool].sort(() => 0.5 - Math.random());
            data.todayTasks = shuffled.slice(0, 3).map(cmd => ({ cmd, status: 'pending' }));
            
            saveAndRender();
        }

        function updateTaskStatus(index, status) {
            if (data.todayTasks[index].status !== 'pending') return;
            data.todayTasks[index].status = status;

            if (status === 'done') {
                data.score += 10;
            } else {
                data.failCount++;
                if (data.failCount >= 3) {
                    triggerPunish();
                }
            }
            saveAndRender();
        }

        // ä¿®æ”¹ï¼šè§¸ç™¼æ‡²ç½°é‚è¼¯ (åŠ å…¥æ•¸å€¼è¨ˆç®—)
        function triggerPunish() {
            if (data.punishPool.length === 0) {
                data.activePunish = "ç„¡é è¨­æ‡²ç½°ï¼Œè«‹è‡ªè¨‚æ‡²ç½°å…§å®¹ï¼";
            } else {
                const idx = Math.floor(Math.random() * data.punishPool.length);
                const task = data.punishPool[idx]; // å–å¾—æŠ½åˆ°çš„æ‡²ç½°ç‰©ä»¶

                let punishString = "";
                
                if (task.type === 'other') {
                    punishString = task.name;
                } else {
                    // æ ¸å¿ƒå…¬å¼ï¼šç•¶å‰æ•¸å€¼ = åŸºç¤å€¼ * (1 + æ¬¡æ•¸ * 5%)
                    let multiplier = 1 + (task.level * 0.05);
                    let finalValue = task.base * multiplier;

                    // æ•¸å€¼è™•ç†ï¼šè¨ˆæ™‚å››æ¨äº”å…¥ï¼Œè¨ˆæ¬¡ä¹Ÿå»ºè­°å–æ•´
                    finalValue = Math.round(finalValue);

                    punishString = `${task.name} ${finalValue} ${task.unit}`;
                    
                    // é‡è¦ï¼šå¢åŠ è©²ä»»å‹™çš„ç´¯è¨ˆç­‰ç´š (level)
                    task.level++; 
                }
                
                data.activePunish = punishString;
            }
            alert("âŒ å¤±æ•—ä¸‰æ¬¡ï¼è§¸ç™¼æ‡²ç½°ï¼š" + data.activePunish);
            saveAndRender(); // å„²å­˜æ›´æ–°å¾Œçš„ level
        }

        function clearPunish() {
            data.activePunish = "";
            data.failCount = 0;
            saveAndRender();
        }

        // ä¿®æ”¹ï¼šæ–°å¢ä»»å‹™é‚è¼¯ (è™•ç†ä¸åŒé¡å‹è¼¸å…¥)
        function addToPool(poolType) {
            if (poolType === 'normal') {
                const input = document.getElementById('taskInput');
                if (!input.value.trim()) return;
                data.normalPool.push(input.value.trim());
                input.value = "";
            } else {
                // è™•ç†æ‡²ç½°æ–°å¢
                const pType = document.getElementById('punishType').value;
                const pName = document.getElementById('punishName').value.trim();
                const pBase = parseFloat(document.getElementById('punishBase').value);
                let pUnit = document.getElementById('punishUnit').value.trim();

                if (!pName) return alert("è«‹è¼¸å…¥ä»»å‹™åç¨±");

                if (pType !== 'other') {
                    if (isNaN(pBase) || pBase <= 0) return alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„åŸºç¤æ•¸å€¼");
                    if (pType === 'time') pUnit = "ç§’"; // å¼·åˆ¶è¨ˆæ™‚å–®ä½ç‚ºç§’
                    if (!pUnit) return alert("è«‹è¼¸å…¥å–®ä½");
                }

                // æ¨é€æ–°çš„ç‰©ä»¶çµæ§‹
                data.punishPool.push({
                    type: pType,
                    name: pName,
                    base: pType === 'other' ? 0 : pBase,
                    unit: pUnit,
                    level: 0 // åˆå§‹ç­‰ç´šç‚º 0
                });

                // æ¸…ç©ºæ¬„ä½
                document.getElementById('punishName').value = "";
                document.getElementById('punishBase').value = "";
                if(pType !== 'time') document.getElementById('punishUnit').value = "";
            }
            saveAndRender();
        }

        function deleteFromPool(type, index) {
            if (type === 'normal') data.normalPool.splice(index, 1);
            else data.punishPool.splice(index, 1);
            saveAndRender();
        }

        // --- 3. ä»‹é¢äº’å‹•è¼”åŠ© ---

        // åˆ‡æ›æ‡²ç½°è¼¸å…¥æ¡†é¡¯ç¤ºç‹€æ…‹
        function togglePunishInputs() {
            const type = document.getElementById('punishType').value;
            const valRow = document.getElementById('punishValueRow');
            const btnRow = document.getElementById('punishBtnRow');
            const unitInput = document.getElementById('punishUnit');

            if (type === 'other') {
                valRow.style.display = 'none'; // éš±è—æ•¸å€¼è¼¸å…¥
                btnRow.style.display = 'flex'; // é¡¯ç¤ºå¤§æŒ‰éˆ•
            } else {
                valRow.style.display = 'flex'; // é¡¯ç¤ºæ•¸å€¼è¼¸å…¥
                btnRow.style.display = 'none'; // éš±è—å¤§æŒ‰éˆ•(ç§»åˆ°æ•¸å€¼è¡Œå¾Œé¢)
                
                if (type === 'time') {
                    unitInput.value = "ç§’";
                    unitInput.disabled = true; // è¨ˆæ™‚å¼·åˆ¶é–å®šå–®ä½
                    unitInput.style.backgroundColor = "#eee";
                } else {
                    unitInput.value = "";
                    unitInput.disabled = false;
                    unitInput.style.backgroundColor = "white";
                    unitInput.placeholder = "å–®ä½ (å¦‚:ä¸‹)";
                }
            }
        }

        // --- 4. æ¸²æŸ“èˆ‡å„²å­˜ ---

        function saveAndRender() {
            localStorage.setItem('task_score', data.score);
            localStorage.setItem('task_fail', data.failCount);
            localStorage.setItem('task_pool_normal', JSON.stringify(data.normalPool));
            localStorage.setItem('task_pool_punish', JSON.stringify(data.punishPool));
            localStorage.setItem('task_today', JSON.stringify(data.todayTasks));
            localStorage.setItem('task_active_punish', data.activePunish);

            document.getElementById('scoreDisplay').innerText = data.score;
            document.getElementById('failDisplay').innerText = data.failCount + " / 3";

            const banner = document.getElementById('punishBanner');
            if (data.activePunish) {
                banner.style.display = 'block';
                document.getElementById('punishText').innerText = data.activePunish;
            } else {
                banner.style.display = 'none';
            }

            const todayDiv = document.getElementById('todayList');
            if (data.todayTasks.length === 0) {
                todayDiv.innerHTML = "å°šæœªæŠ½å–ä»»å‹™";
            } else {
                todayDiv.innerHTML = data.todayTasks.map((t, i) => `
                    <div class="item">
                        <span class="task-text" style="${t.status !== 'pending' ? 'text-decoration: line-through; color: #999;' : ''}">${t.cmd}</span>
                        ${t.status === 'pending' ? `
                            <button class="btn-ok" onclick="updateTaskStatus(${i}, 'done')">å®Œæˆ</button>
                            <button class="btn-no" onclick="updateTaskStatus(${i}, 'fail')">å¤±æ•—</button>
                        ` : `<span>${t.status === 'done' ? 'âœ…' : 'âŒ'}</span>`}
                    </div>
                `).join('');
            }

            renderPoolList('normalPool', 'normal');
            renderPunishList(); // æ‡²ç½°åˆ—è¡¨æœ‰ä¸åŒæ¸²æŸ“æ–¹å¼
        }

        function renderPoolList(elementId, type) {
            // åªè™•ç†ä¸€èˆ¬ä»»å‹™ï¼Œæ‡²ç½°ä»»å‹™åˆ†é–‹è™•ç†
            const list = data.normalPool;
            document.getElementById(elementId).innerHTML = list.map((cmd, i) => `
                <div class="item">
                    <span style="font-size: 14px;">${cmd}</span>
                    <button class="btn-del" onclick="deleteFromPool('${type}', ${i})">åˆªé™¤</button>
                </div>
            `).join('');
        }

        // å°ˆé–€æ¸²æŸ“æ‡²ç½°åˆ—è¡¨ (é¡¯ç¤ºç­‰ç´šèˆ‡æ•¸å€¼è³‡è¨Š)
        function renderPunishList() {
            const list = data.punishPool;
            document.getElementById('punishPool').innerHTML = list.map((item, i) => {
                let desc = "";
                if (item.type === 'other') {
                    desc = item.name;
                } else {
                    // é¡¯ç¤ºç•¶å‰é›£åº¦é è¦½
                    const nextVal = Math.round(item.base * (1 + item.level * 0.05));
                    // é¡¯ç¤ºæ ¼å¼ï¼šæ·±è¹² (Lv.2 - 55ä¸‹)
                    desc = `<b>${item.name}</b> <span style="color:#666; font-size:12px;">(Lv.${item.level} | ä¸‹æ¬¡: ${nextVal}${item.unit})</span>`;
                }

                return `
                <div class="item">
                    <span style="font-size: 14px;">${desc}</span>
                    <button class="btn-del" onclick="deleteFromPool('punish', ${i})">åˆªé™¤</button>
                </div>
            `}).join('');
        }

        // åˆå§‹åŒ–
        togglePunishInputs(); // è¨­å®šåˆå§‹è¼¸å…¥æ¡†ç‹€æ…‹
        saveAndRender();

    </script>
</body>
</html>
